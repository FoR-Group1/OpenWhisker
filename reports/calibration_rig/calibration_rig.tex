\documentclass[runningheads]{llncs}
\usepackage[T1]{fontenc}
\usepackage{float}
\usepackage{graphicx} % Required for inserting images
\bibliographystyle{splncs04}

\usepackage[colorlinks,linkcolor = black, citecolor=black,urlcolor=black,bookmarks=false,hypertexnames=true]{hyperref}

\usepackage{blindtext}

\usepackage[most]{tcolorbox}

\title{OpenWhisker - A Open Source Whisker Sensor Platform}

\author{Liyou Zhou\inst{1}\orcidID{0009-0005-9491-9003} \and
Second Author\inst{1}\orcidID{1111-2222-3333-4444} \and
Third Author\inst{1}\orcidID{2222--3333-4444-5555}}


\institute{University of Lincoln, Lincoln, UK}
%

\authorrunning{L. Zhou et al.}

\date{\today}

\begin{document}

\maketitle

\begin{abstract}
    Whisker sensors are a type of tactile sensor that mimics the whiskers of animals. It has been an active area of research in recent years for its interesting use-cases in robotics and whiskered mammal physiology research\cite{prescottActiveTouchSensing2020}. Several attempts have been made to develop an open source low cost version of the sensor so that it can be used in a wider range of applications. However, the calibration processes presented, remain time-consuming and error-prone. In this paper we present a low-cost open source whisker calibration platform based on a 3d printer to perform automated, high precision and repeatable calibration of whisker sensors. We demonstrate the efficacy of the platform in calibrating sensors for SLAM and Material detection tasks.
    
    \keywords{Whisker Sensor \and Calibration \and Open Source}
\end{abstract}

\section{Introduction}

Whisker sensors are a type of tactile sensor that mimics the whiskers of rodents. It has been an active area of research in recent years for its interesting use-cases in robotics and whiskered mammal physiology research\cite{prescottActiveTouchSensing2020}. \cite{fotouhiDetectionBarelyVisible2021} shows its use in material defect identification. \cite{struckmeierViTaSLAMBioinspiredVisuoTactile2019} and \cite{foxTactileSLAMBiomimetic2012} demonstrates its successful use in SLAM tasks.

The existing research initiatives all endeavours to build the whisker sensor and testing platform from scratch. This is a time-consuming and expensive process. There is a clear need for an open source whisker sensor platform to lower the barrier of entry for research and development in this area.

The project group set out fulfil this gap by developing a low-cost open source whisker sensor and testing platform. We demonstrate that a whisker sensor can be built using off-the-shelf components and 3d printed parts. The sensor is integrated with ROS 2 to provide a convenient interface for data collection and analysis. We demonstrate the use of a 3d printer as an automated and repeatable experimentation platform for whisker sensors. We also provide a calibration routine to establish a relationship between the sensor readings and the radial location of the contact. Thus, the sensor can be used in SLAM tasks.

\section{Solution Overview}

The whisker sensor assembly (Fig. \ref{fig:whisker_sensor_cross_section}) is made up of 4 main components:
\begin{itemize}
    \item \textbf{Whisker Shaft} The whisker shaft is 3D printed using PETG or PLA. The shaft is either tapered or cylindrical. A magnet is embedded in the base of the shaft.
    \item \textbf{Magnetometer} A magnetometer (MLX90393 \cite{industriesAdafruitWideRangeTripleaxis}) is attached to the base of the Sensor housing such that the magnet overs just in front. It measures the displacement of the base of whisker shaft by sensing the change in magnetic field. The magnetometer is interfaced with a microcontroller (Raspberry Pi Pico \cite{ltdBuyRaspberryPi}) via I2C and the reading is relayed to a host computer via a serial port.
    \item \textbf{Flexible 3d printed hinge} A 3d printed O-shaped hinge is used to marry the shaft to the sensor housing. The hinge is printed in a flexible material (TPU 85A \cite{NinjaFlex85ATPU}) such that the shaft is flexible to twist around the hinge.
    \item \textbf{3d printed housing} The housing is 3d printed using PETG.
\end{itemize}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{figures/whisker_cross_section.png}
    \caption{Whisker Sensor Assembly}
    \label{fig:whisker_sensor_cross_section}
\end{figure}

A 3d printer is repurposed to be an automated calibration rig for the sensor (Fig. \ref{fig:calibration_rig}). The whisker sensor is mounted onto the printer bed while a metal rod is mounted onto the printer head. The printer is instructed to make contact with the whisker shaft at a series of known locations. The contact is made in a swift back and forth motion to mimic whisking action. The sensor reading as well as the x, y, z position of the printer head is recorded via the host computer using ROS2.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{figures/3d_printer_overview.jpg}
    \caption{3D Printer based Calibration Rig}
    \label{fig:calibration_rig}
\end{figure}

The data is used to calibrate a regression model between the sensor reading and the radial location of the contact. The model is loaded into the whisker sensor ROS2 driver to provide real time radial contact location estimation.

\vspace{20px}



\section{ROS integration}

A driver is written to integrate the sensor and the calibration process, including the 3d printer into ROS 2. The driver has the following main components:

\begin{itemize}
    \item \textbf{whisker\_driver\_node} Interfaces with the whisker sensor micro-controller via a serial port. Publishes data on the topic \verb|/magnetometer_reading|.
    \item  \textbf{printer\_driver\_node} Interfaces with the 3d printer, drive it to go through a calibration sequence upon a service call.
    \item \textbf{whisker\_interfaces} Message and service definitions for the drivers.
\end{itemize}

\subsection{whisker\_driver\_node}

The magnetometer is interfaced with the Raspberry Pi Pico via I2C. The Pico is programmed \footnote{Pico software written by team member Jacob Swindell} to output the readings via the serial port at a baud rate of 115200. The serial outputs looks like:
\begin{verbatim}
    95afecd5 - 850
    95a1e8d5 - 839
    941fe7d4 - 842
    932afed3 - 844
    ...
\end{verbatim}

The first 2 digits is a sensor status code followed by hex encoded reading for the x, y, z axis. Each axis is represented by 2 hex digits as the sensor have maximum 16 bit resolution. The number at the end of the line is the operating frequency of the sensor in Hz. At 15 characters per line, 8 bits per character, sensor operating at around 850 Hz, the serial port is transporting 102,000 bits per second. This is within the 115,200 bps limit of the serial port.

As the microcontroller does not relay the timestamp of individual readings, the reading is timestamped with the host computer's system clock on reception at the serial port. A small delay would be expected between the time the reading is taken and the timestamp and could limit the sensor's use in high speed/precision applications.

Publishing sensor reading on ROS2 middleware at 850Hz strains the host computer system. Instead, the driver node reads the serial port, parses the x, y, z readings and stores them in a buffer. In a periodic timer callback, all readings in the buffer are published on a single custom message of type \verb|MagnetometerReadingArray|.

In the same timer callback, a running window of past readings is used to detect contact and estimate the radial location of the contact. The raw sensor reading is first de-noised using a low-pass filter. Then an heuristic is use to detect a contact event. The heuristic detects an falling edge and a rising edge in the first derivative of sensor reading. A polynomial regression model is then used to predict radial contact distance from the derivative data.
The radial location is published on the topic \verb|/detected_contact| as a \verb|/PoseStamped| message. See section \ref{sec:calibration_data_analysis} for details on the data processing and prediction pipeline.

\subsection{printer\_driver\_node}

The printer driver node interfaces with the 3d printer via a python API \footnote{3D printer python API written by team member Omar Ali}. The node provides a ROS service \verb|/calibrate_whisker| which instructs the printer to go through a calibration sequence. At the same time the x, y, z position of the printer head is recorded and published as a transform between the 2 frames \verb|/printer_base_link| and \verb|/printer_head_link|. The printer head location is polled from the API at a fixed interval. As getting head location and sending move commands are done on the same serial link, they tend to interfere with each other. Hence guards are put in place to ensure there is no contention on the wire. Due to the limitation of the printer hardware, the commands cannot be sent too fast. As a result, the data rate from the printer is much lower than the magnetometer.

\subsection{whisker\_interfaces}

The nodes are written to use standard ROS2 message and service definitions as much as possible. The custom message \verb|MagnetometerReadingArray| is defined to hold an array of \verb|MagnetometerReading| messages. The custom service \verb|IncrementsBeamTest| is defined drive the calibration sequence of the 3D printer.

It is good practice to specify ROS 2 message definitions in a separate package and be versioned separately than any functional nodes. That way interoperability is ensured through careful control of the interface messages.

As a result of the use of ROS 2 eco-system and standard ros2 interface messages, the project benefits from a wide range of open source ROS 2 tools for data collection and analysis. The \verb|ros2 bag| utility is used to record the data from the printer driver node and the whisker driver node for calibration. \verb|foxglove| is used to visualize the data (Fig. \ref{fig:foxglove}).

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{figures/foxglove_visualisation.png}
    \caption{Foxglove visualization of whisker sensor system running in ROS 2}
    \label{fig:foxglove}
\end{figure}

\section{Whisker Model}

In order to make the sensor useful in SLAM tasks, it is necessary not  only to sense when contact happens, but also estimate the exact location along the whisker where contact is made. As such, we need to establish a relationship between the sensor readings and the location of the contact.

\subsection{Calibration Routine}

Using the ROS 2 \textbf{printer\_driver\_node}, the printer is instructed to make contact with the whisker shaft at a series of known locations. The contact is made in a swift back and forth motion to mimic whisking action. Reading from the sensor as well as the x, y, z position of the printer head is easily recorded via the ROS 2 \textbf{rosbag} utility. Fig.~\ref{fig:calibration_routine} shows the raw data collected from 3 consecutive calibration runs.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.49\textwidth]{figures/raw_magnetometer.png}
    \includegraphics[width=0.49\textwidth]{figures/3d_printer_raw.png}
    \caption{Raw Magnetometer and 3D Printer Data from 3 consecutive Calibration Routines}
    \label{fig:calibration_routine}
\end{figure}

\subsection{Calibration Data Analysis}\label{sec:calibration_data_analysis}

The raw magnetometer readings are noisy, hence as a first step, a low pass Butterworth filter is applied to the data. A comparison of raw and filtered data is shown in Fig.~\ref{fig:filtered_magnetometer}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{figures/filtered_magnetometer.png}
    \caption{Raw and Filtered Magnetometer Reading in the X Axis }
    \label{fig:filtered_magnetometer}
\end{figure}

In the next step, each episode of contact is isolated and extracted from the time series. It is done by detecting a negative speed at the start of contact and a positive speed at the end of the episode in the y direction of the magnetometer readings. The isolated episodes are shown in Fig.~\ref{fig:episodes_y_data.png}. The data contains only the forward whisk. In an realistic whisking scenario, there is uncertainty as to how far along the whisk a contact is made and a detection algorithm should be able to detect contact with as little data as possible to minimize latency.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.6\textwidth]{figures/episodes_y_data.png}
    \caption{Isolated Contact Episodes. x axis is time in seconds, y axis is the magnetometer reading in the y channel}
    \label{fig:episodes_y_data.png}
\end{figure}

Another unrealistic aspect of the calibration routine is that the printer header is always moving at a constant speed wherever the contact is made along the shaft. In a realistic whisking motion, the shaft rotates around the base and the orthogonal speed \(\dot{y}\) is proportional to the distance from the base \(x\) and the angular speed \(\dot{\theta}\).

\[\dot{y} = \dot{\theta}x\]\label{eq:linear_relationship}

To correct for this effect, we scale the derivative of senor reading by a factor of \(x\) to simulate a constant angular velocity in all data. The corrected derivative of sensor reading is plotted in Fig.~\ref{fig:corrected_derivative.png}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{figures/corrected_derivative.png}
    \caption{Corrected \(\dot{y}\) of the Isolated Contact Episodes. Each episode is 1 line and the color corresponds to the distance from the base of the whisker \(x\) where contact is made}
    \label{fig:corrected_derivative.png}
\end{figure}

It can be seen there is a clear correlation between \(\dot{y}\) and \(x\). Fig. \ref*{fig:x_y_relationship.png} plots the Nth data point in each episode against the distance from the base of the whisker \(x\). It can be seen that there is a clear corelation but the relationship is not linear as suggested by Eq. \ref*{eq:linear_relationship}. The deflection in \(y\) at the contact point of the whisker has 2 components,
\begin{itemize}
    \item displacement due to twisting of the gel material \(y_{twist}\).
    \item displacement due to bending of the whisker shaft \(y_{bend}\).
\end{itemize}
\[y_{contact} = y_{twist} + y_{bend}\]
While \(y_{twist}\) creates a directly proportional reading at the magnetometer sensor, the bending of the whisker shaft \(y_{bend}\) causes non-linearity.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{figures/x_y_relationship.png}
    \caption{Nth data point of \(\dot{y}\) in each episode against the distance from the base of the whisker \(x\) where contact is made. The color corresponds to the value of N}
    \label{fig:x_y_relationship.png}
\end{figure}


Picking the 120th sample in each episode, this relationship between \(x\) and \(\dot{y}\) is modelled using a third order polynomial via a least square regression algorithm. Fig. \ref*{fig:polynomial_regression.png} plots the final fitted curve.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{figures/polynomial_regression.png}
    \caption{Polynomial Regression of the relationship 100th sample of \(\dot{y}\) in each episode and the contact distance \(x\)}
    \label{fig:polynomial_regression.png}
\end{figure}

The parameters of the polynomial is saved and used in the whisker driver node to estimate the contact location in real time. The benefit of a polynomial model is that it is very quick to compute. On a resource constrained robotic application with many whisker sensors, such a low-demand algorithm is desirable.

\section{Why does the whisker need to be bendable?}

All the above analysis is done using a whisker shaft printed in PLA and is tapered in shape. This cause the whisker to bend easily. An alternative design is produced \footnote{design and produce by team member Emmanuel Soumo} using PETG and is cylindrical in shape and uniform cross-section throughout the length. The PETG whisker is rigid and does not bend when pushed. The PETG whisker is tested using the same calibration routine. A graph of the derivative of sensor reading during each contact episode is produced in Fig. \ref*{fig:pteg_episodes.png}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{figures/pteg_episodes.png}
    \caption{Corrected \(\dot{y}\) of the Isolated Contact Episodes. Each episode is 1 line and the color corresponds to the distance from the base of the whisker \(x\) where contact is made}
    \label{fig:pteg_episodes.png}
\end{figure}

In this rigid whisker case, the sensor reading follows pretty much the same curve no matter where along the shaft the contact is made. This makes it impossible to estimate the contact location based on the sensor readings. Mathematically, this is expected. Recall:

    \[y_{contact} = y_{twist} + y_{bend}\]

And in this case \(y_{bend}\) is negligible. Hence, we have:

    \[\dot{y}_{contact} = \dot{y}_{twist}\]

Since the shaft is rigid, the movement at the base of the shaft (i.e. the end with the magnet) is proportional to the movement at the tip of the shaft and the distance along the shaft where contact is made \(x\)

    \[\dot{y}_{contact} = \alpha\times\dot{y}_{base}\times x\]

Also recall in a whisking motion, the speed of the shaft at the point of contact is also proportional to \(x\)

    \[\dot{y}_{contact} = \dot{\theta}x\]

Combining the 2 equations above, we have:

    \[\dot{y}_{base} = \frac{\dot{\theta}}{\alpha} \]

Which means, the reading we have at the base of the whisker, is only related to the angular speed of the whisker and is independent of the contact location.

Further evidence can be seen in the tapered PLA whisker case, in Fig.~\ref*{fig:corrected_derivative.png}. When the contact point is towards the base of the shaft, the parametric curve fails. The first derivative of sensor reading seem to be the same for different contact points. This is because at the base, the shaft is thicker and stiffer. The bending of the shaft is less pronounced and the sensor reading is again dominated by \({y}_{twist}\).

Hence, the flexibility of the whisker shaft is crucial to the successful operation of the sensor.


\section{Conclusion}

All artefacts of the solution can be viewed at:

\url{https://github.com/FoR-Group1/OpenWhisker}.


As a result of the project, a fully re-producible cost-effective whisker sensor platform is developed and made available via open source software and hardware. The sensor itself uses off-the-shelf or 3d printed components. We avoid harmful chemicals in choosing to produce the flexible hinge using 3d printing with TPU. The utilization of a 3d printer as a calibration rig reduces the cost of the calibration process and makes it accessible to a wider audience. The integration with ROS 2 provides a convenient interface for data collection and analysis. The ability to estimate the radial location of contact in real time makes the sensor useful in SLAM tasks. There is huge potential in further development based on the project's work, and we hope to see more people joining the effort.

\bibliography{Whiskers.bib}

\end{document}
